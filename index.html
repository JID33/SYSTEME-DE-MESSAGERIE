<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">Lottery System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS CDN for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                justify-content: space-around;
                align-items: flex-start;
            }
        }

        .input-section, .wheel-section {
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            background-color: #f9fafb;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            min-width: 300px;
        }

        .wheel-container {
            position: relative;
            width: 300px; /* Base size for the wheel */
            height: 300px;
            border-radius: 50%;
            overflow: hidden;
            border: 8px solid #3b82f6; /* Blue border */
            box-shadow: 0 0 0 5px #bfdbfe, 0 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 6s cubic-bezier(0.25, 0.1, 0.25, 1); /* Smooth spin transition */
            margin: 0 auto;
        }

        .wheel-segment {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: 50% 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
            padding-top: 20px; /* Push text down to avoid center overlap */
        }

        .pointer {
            position: absolute;
            top: -25px; /* Position above the wheel */
            left: 50%;
            transform: translateX(-50%);
            color: #ef4444; /* Red color for the pointer */
            font-size: 50px;
            z-index: 10;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .result-display {
            background-color: #ecfdf5; /* Light green background for result */
            color: #047857; /* Dark green text */
            padding: 20px;
            border-radius: 15px;
            font-size: 2.25rem; /* Large font size */
            font-weight: 700;
            text-align: center;
            margin-top: 20px;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            opacity: 0; /* Hidden by default */
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .result-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive adjustments for wheel size */
        @media (max-width: 767px) {
            .wheel-container {
                width: 250px;
                height: 250px;
            }
            .wheel-segment {
                font-size: 12px;
            }
            .pointer {
                font-size: 40px;
                top: -20px;
            }
            .result-display {
                font-size: 1.75rem;
            }
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .modal-content button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .modal-content .error-message {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: -10px;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 p-5 flex items-center justify-center min-h-screen">
    <div class="container bg-white rounded-3xl shadow-xl p-8 md:p-12 flex flex-col md:flex-row gap-8 items-center md:items-start">

        <!-- Language Selector -->
        <div class="absolute top-4 right-4 z-50">
            <select id="languageSelector" class="p-2 rounded-md border border-gray-300 bg-white shadow-sm">
                <option value="en">English</option>
                <option value="fr">Français</option>
            </select>
        </div>

        <!-- Participant Input Section -->
        <div class="input-section w-full md:w-1/2 p-6 bg-blue-50 rounded-2xl shadow-md">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" data-i18n="addParticipantsTitle">Add Participants</h2>

            <!-- Mode Selector -->
            <div class="flex justify-center gap-4 mb-6">
                <label class="inline-flex items-center">
                    <input type="radio" name="mode" value="names" checked class="form-radio h-5 w-5 text-blue-600">
                    <span class="ml-2 text-gray-700 font-medium" data-i18n="namesLabel">Names</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="mode" value="numbers" class="form-radio h-5 w-5 text-purple-600">
                    <span class="ml-2 text-gray-700 font-medium" data-i18n="numbersLabel">Numbers</span>
                </label>
            </div>

            <textarea id="participantsInput"
                      class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 resize-y"
                      data-i18n-placeholder="namesPlaceholder"
                      placeholder="Enter names here, one per line or separated by commas (e.g., John, Mary, Peter)"></textarea>
            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                <button id="addParticipantsBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                        data-i18n="addParticipantsBtn">
                    <i class="fas fa-plus-circle mr-2"></i> Add Participants
                </button>
                <button id="clearParticipantsBtn"
                        class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75"
                        data-i18n="clearAllBtn">
                    <i class="fas fa-trash-alt mr-2"></i> Clear All
                </button>
            </div>
            <p id="participantCount" class="text-gray-600 text-sm mt-4 text-center">0 participant(s) added.</p>
        </div>

        <!-- Wheel Section -->
        <div class="wheel-section w-full md:w-1/2 p-6 bg-purple-50 rounded-2xl shadow-md flex flex-col items-center justify-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" data-i18n="wheelTitle">Wheel of Fortune</h2>
            <div class="wheel-container relative">
                <div id="wheel" class="w-full h-full rounded-full relative transition-transform duration-600 ease-out">
                    <!-- Segments will be generated here by JavaScript -->
                </div>
                <i class="fas fa-caret-up pointer"></i> <!-- Pointer to indicate the winner -->
            </div>
            <button id="spinBtn"
                    class="mt-8 bg-green-500 hover:bg-green-600 text-white font-extrabold py-4 px-10 rounded-full shadow-xl transform hover:scale-110 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-400 focus:ring-opacity-75 text-xl uppercase tracking-wider disabled:opacity-50 disabled:cursor-not-allowed"
                    data-i18n="spinBtn">
                <i class="fas fa-dice-one mr-3"></i> Spin the Wheel!
            </button>

            <!-- Result Display -->
            <div id="resultDisplay" class="result-display hidden">
                <span id="winnerValue"></span>
            </div>

            <!-- Export Excel Button -->
            <button id="exportExcelBtn"
                    class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed"
                    data-i18n="exportExcelBtn">
                <i class="fas fa-file-excel mr-2"></i> Export to Excel
            </button>

            <!-- Settings Button (to change password) -->
            <button id="settingsBtn"
                    class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75"
                    data-i18n="settingsBtn">
                <i class="fas fa-cog mr-2"></i> Settings
            </button>
        </div>
    </div>

    <!-- Modal for password input for export -->
    <div id="passwordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center" data-i18n="passwordRequiredTitle">Password Required</h3>
            <p class="text-gray-600 mb-4 text-center" data-i18n="passwordRequiredMsg">Please enter the password to export the Excel file.</p>
            <input type="password" id="exportPasswordInput" data-i18n-placeholder="passwordPlaceholder" placeholder="Password" class="mb-3">
            <p id="passwordErrorMsg" class="error-message hidden" data-i18n="incorrectPassword">Incorrect password.</p>
            <div class="flex justify-end gap-3 mt-4">
                <button id="passwordCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800" data-i18n="cancelBtn">Cancel</button>
                <button id="passwordSubmitBtn" class="bg-blue-600 hover:bg-blue-700 text-white" data-i18n="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal for changing password -->
    <div id="changePasswordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center" data-i18n="changePasswordTitle">Change Password</h3>
            <input type="password" id="newPasswordInput" data-i18n-placeholder="newPasswordPlaceholder" placeholder="New Password" class="mb-3">
            <input type="password" id="confirmNewPasswordInput" data-i18n-placeholder="confirmNewPasswordPlaceholder" placeholder="Confirm New Password" class="mb-3">
            <p id="changePasswordErrorMsg" class="error-message hidden" data-i18n="passwordMismatch">Passwords do not match or are empty.</p>
            <div class="flex justify-end gap-3 mt-4">
                <button id="changePasswordCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800" data-i18n="cancelBtn">Cancel</button>
                <button id="changePasswordSubmitBtn" class="bg-blue-600 hover:bg-blue-700 text-white" data-i18n="changeBtn">Change</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal for Clear All -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center" data-i18n="clearConfirmationTitle">Confirm Clear All</h3>
            <p class="text-gray-600 mb-4 text-center" data-i18n="clearConfirmationMessage">Are you sure you want to clear all participants and history?</p>
            <div class="flex justify-end gap-3 mt-4">
                <button id="confirmCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800" data-i18n="cancelBtn">Cancel</button>
                <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-600 text-white" data-i18n="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Array to store participants (names or numbers)
        let participants = [];
        // Variable to store the current rotation of the wheel
        let currentRotation = 0;
        // Flag to indicate if the wheel is spinning
        let isSpinning = false;
        // Current drawing mode: 'names' or 'numbers'
        let drawingMode = 'names';
        // Array to store winning history for Excel export
        let winnerHistory = [];
        // Export password (default value)
        let exportPassword = "admin123"; // Default password
        // Current language, default to English
        let currentLanguage = 'en';

        // Translation object
        const translations = {
            en: {
                appTitle: "Lottery System",
                addParticipantsTitle: "Add Participants",
                wheelTitle: "Wheel of Fortune",
                namesLabel: "Names",
                numbersLabel: "Numbers",
                namesPlaceholder: "Enter names here, one per line or separated by commas (e.g., John, Mary, Peter)",
                numbersPlaceholder: "Enter numbers here, one per line or separated by commas (e.g., 1, 5, 10)",
                addParticipantsBtn: "Add Participants",
                clearAllBtn: "Clear All",
                spinBtn: "Spin the Wheel!",
                exportExcelBtn: "Export to Excel",
                settingsBtn: "Settings",
                participantCountPrefix: "0 participant(s) added.", // Dynamic part will be handled by JS
                participantCountSuffix: " participant(s) added.",
                passwordRequiredTitle: "Password Required",
                passwordRequiredMsg: "Please enter the password to export the Excel file.",
                passwordPlaceholder: "Password",
                incorrectPassword: "Incorrect password.",
                cancelBtn: "Cancel",
                confirmBtn: "Confirm",
                changePasswordTitle: "Change Password",
                newPasswordPlaceholder: "New Password",
                confirmNewPasswordPlaceholder: "Confirm New Password",
                passwordMismatch: "Passwords do not match or are empty.",
                passwordEmpty: "Passwords cannot be empty.",
                passwordsDoNotMatch: "Passwords do not match.",
                changeBtn: "Change",
                excelHeaders: ["Winning Value", "Draw Date", "Slogan"],
                winningSlogan: "Congratulations to the winner!",
                noDrawsToExport: "No draws have been made to export.",
                invalidNumbersWarning: "Some entries were not valid numbers and have been ignored.",
                clearConfirmationTitle: "Confirm Clear All",
                clearConfirmationMessage: "Are you sure you want to clear all participants and history?"
            },
            fr: {
                appTitle: "Système de Tirage",
                addParticipantsTitle: "Ajouter les Participants",
                wheelTitle: "La Roue du Destin",
                namesLabel: "Noms",
                numbersLabel: "Chiffres",
                namesPlaceholder: "Entrez les noms ici, un par ligne ou séparés par des virgules (ex: Jean, Marie, Pierre)",
                numbersPlaceholder: "Entrez les chiffres ici, un par ligne ou séparés par des virgules (ex: 1, 5, 10)",
                addParticipantsBtn: "Ajouter les Participants",
                clearAllBtn: "Effacer tout",
                spinBtn: "Lancer le Tirage !",
                exportExcelBtn: "Exporter en Excel",
                settingsBtn: "Paramètres",
                participantCountPrefix: "0 participant(s) ajouté(s).",
                participantCountSuffix: " participant(s) ajouté(s).",
                passwordRequiredTitle: "Mot de passe requis",
                passwordRequiredMsg: "Veuillez entrer le mot de passe pour exporter le fichier Excel.",
                passwordPlaceholder: "Mot de passe",
                incorrectPassword: "Mot de passe incorrect.",
                cancelBtn: "Annuler",
                confirmBtn: "Confirmer",
                changePasswordTitle: "Changer le mot de passe",
                newPasswordPlaceholder: "Nouveau mot de passe",
                confirmNewPasswordPlaceholder: "Confirmer le nouveau mot de passe",
                passwordMismatch: "Les mots de passe ne correspondent pas ou sont vides.",
                passwordEmpty: "Les mots de passe ne peuvent pas être vides.",
                passwordsDoNotMatch: "Les mots de passe ne correspondent pas.",
                changeBtn: "Changer",
                excelHeaders: ["Valeur Gagnante", "Date du Tirage", "Slogan"],
                winningSlogan: "Félicitations au gagnant !",
                noDrawsToExport: "Aucun tirage n'a été effectué pour exporter.",
                invalidNumbersWarning: "Certaines entrées n'étaient pas des nombres valides et ont été ignorées.",
                clearConfirmationTitle: "Confirmer l'Effacement",
                clearConfirmationMessage: "Êtes-vous sûr de vouloir effacer tous les participants et l'historique ?"
            }
        };

        // DOM elements
        const languageSelector = document.getElementById('languageSelector');
        const participantsInput = document.getElementById('participantsInput');
        const addParticipantsBtn = document.getElementById('addParticipantsBtn');
        const clearParticipantsBtn = document.getElementById('clearParticipantsBtn');
        const participantCountDisplay = document.getElementById('participantCount');
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spinBtn');
        const resultDisplay = document.getElementById('resultDisplay');
        const winnerValueDisplay = document.getElementById('winnerValue');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const settingsBtn = document.getElementById('settingsBtn');

        // Password Modal elements
        const passwordModal = document.getElementById('passwordModal');
        const exportPasswordInput = document.getElementById('exportPasswordInput');
        const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
        const passwordCancelBtn = document.getElementById('passwordCancelBtn');
        const passwordErrorMsg = document.getElementById('passwordErrorMsg');

        // Change Password Modal elements
        const changePasswordModal = document.getElementById('changePasswordModal');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
        const changePasswordSubmitBtn = document.getElementById('changePasswordSubmitBtn');
        const changePasswordCancelBtn = document.getElementById('changePasswordCancelBtn');
        const changePasswordErrorMsg = document.getElementById('changePasswordErrorMsg');

        // Confirmation Modal elements for Clear All
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');

        // Colors for wheel segments
        const segmentColors = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef',
            '#ec4899', '#f43f5e', '#fb7185', '#be123c', '#9f1239', '#881337', '#7f1d1d', '#b91c1c', '#dc2626', '#ef4444'
        ];

        /**
         * Sets the language of the application.
         * @param {string} lang - The language code ('en' or 'fr').
         */
        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang; // Set HTML lang attribute

            // Update title
            document.querySelector('title').textContent = translations[lang].appTitle;

            // Update elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update placeholders with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Update specific dynamic elements
            updateParticipantCount(); // This will use the correct translation for count
            // Update input placeholder based on current drawing mode
            if (drawingMode === 'numbers') {
                participantsInput.placeholder = translations[lang].numbersPlaceholder;
            } else {
                participantsInput.placeholder = translations[lang].namesPlaceholder;
            }
        }

        /**
         * Shows a modal by adding the 'show' class and removing 'hidden'.
         * @param {HTMLElement} modalElement The modal DOM element.
         */
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            // Force reflow to ensure transition plays
            void modalElement.offsetWidth;
            modalElement.classList.add('show');
        }

        /**
         * Hides a modal by removing the 'show' class and adding 'hidden' after transition.
         * @param {HTMLElement} modalElement The modal DOM element.
         */
        function hideModal(modalElement) {
            modalElement.classList.remove('show');
            modalElement.addEventListener('transitionend', function handler() {
                modalElement.classList.add('hidden');
                modalElement.removeEventListener('transitionend', handler);
            });
        }

        /**
         * Updates the participant count display and spin button state.
         */
        function updateParticipantCount() {
            participantCountDisplay.textContent = `${participants.length}${translations[currentLanguage].participantCountSuffix}`;
            spinBtn.disabled = participants.length < 2 || isSpinning;
            exportExcelBtn.disabled = winnerHistory.length === 0; // Disable export if no winners
        }

        /**
         * Draws the wheel segments based on the participants array.
         */
        function drawWheel() {
            wheel.innerHTML = ''; // Clear existing segments
            resultDisplay.classList.add('hidden'); // Hide previous result
            resultDisplay.classList.remove('show'); // Reset result animation

            if (participants.length === 0) {
                wheel.style.transform = `rotate(0deg)`; // Reset visual rotation
                currentRotation = 0; // Reset logical rotation
                updateParticipantCount();
                return;
            }

            const segmentAngle = 360 / participants.length;

            participants.forEach((participant, index) => {
                const segment = document.createElement('div');
                segment.classList.add('wheel-segment');
                const rotation = index * segmentAngle;
                const color = segmentColors[index % segmentColors.length];

                segment.style.backgroundColor = color;
                segment.style.transform = `rotate(${rotation}deg) skewY(${90 - segmentAngle}deg)`;
                segment.style.clipPath = `polygon(0% 0%, 100% 0%, 50% 100%)`;

                const textContainer = document.createElement('div');
                textContainer.textContent = participant;
                textContainer.style.transform = `skewY(${-(90 - segmentAngle)}deg) rotate(${segmentAngle / 2}deg)`;
                textContainer.style.position = 'absolute';
                textContainer.style.whiteSpace = 'nowrap';
                textContainer.style.overflow = 'hidden';
                textContainer.style.textOverflow = 'ellipsis';
                textContainer.style.maxWidth = '80%';

                segment.appendChild(textContainer);
                wheel.appendChild(segment);
            });

            wheel.style.transform = `rotate(${currentRotation}deg)`;
            updateParticipantCount();
        }

        /**
         * Handles adding participants from the input field based on the selected mode.
         */
        addParticipantsBtn.addEventListener('click', () => {
            const inputVal = participantsInput.value.trim();
            if (inputVal) {
                const rawNewParticipants = inputVal.split(/[\n,]+/).map(item => item.trim()).filter(item => item !== '');
                let newParticipants = [];

                if (drawingMode === 'numbers') {
                    newParticipants = rawNewParticipants.filter(item => {
                        // Check if it's a valid number and not just an empty string after conversion
                        return !isNaN(item) && item !== '';
                    }).map(Number);
                    if (newParticipants.length !== rawNewParticipants.length) {
                        // Display a message for invalid numbers
                        passwordErrorMsg.textContent = translations[currentLanguage].invalidNumbersWarning;
                        passwordErrorMsg.classList.remove('hidden');
                        setTimeout(() => passwordErrorMsg.classList.add('hidden'), 3000); // Hide after 3 seconds
                    }
                } else { // names mode
                    newParticipants = rawNewParticipants;
                }

                participants.push(...newParticipants);
                participantsInput.value = ''; // Clear input field
                drawWheel(); // Redraw wheel with new participants
            }
        });

        /**
         * Handles clearing all participants.
         */
        clearParticipantsBtn.addEventListener('click', () => {
            showModal(confirmationModal); // Show custom confirmation modal
        });

        // Event listeners for custom confirmation modal
        confirmYesBtn.addEventListener('click', () => {
            participants = [];
            currentRotation = 0; // Reset rotation
            winnerHistory = []; // Clear winner history as well
            drawWheel(); // Redraw empty wheel
            hideModal(confirmationModal);
        });

        confirmCancelBtn.addEventListener('click', () => {
            hideModal(confirmationModal);
        });

        /**
         * Handles the spin button click event.
         */
        spinBtn.addEventListener('click', () => {
            if (isSpinning || participants.length < 2) {
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            resultDisplay.classList.add('hidden');
            resultDisplay.classList.remove('show');

            const randomIndex = Math.floor(Math.random() * participants.length);
            const winner = participants[randomIndex];
            winnerValueDisplay.textContent = winner;

            const segmentAngle = 360 / participants.length;
            let targetAbsoluteRotation = 360 - (randomIndex * segmentAngle + segmentAngle / 2);

            targetAbsoluteRotation = targetAbsoluteRotation % 360;
            if (targetAbsoluteRotation < 0) {
                targetAbsoluteRotation += 360;
            }

            let rotationNeeded = targetAbsoluteRotation - (currentRotation % 360);
            if (rotationNeeded < 0) {
                rotationNeeded += 360;
            }

            let degreesToSpin = currentRotation + rotationNeeded + (360 * 5); // 5 full spins for effect

            wheel.style.transition = 'transform 6s cubic-bezier(0.25, 0.1, 0.25, 1)';
            wheel.style.transform = `rotate(${degreesToSpin}deg)`;
            currentRotation = degreesToSpin;

            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                resultDisplay.classList.remove('hidden');
                resultDisplay.classList.add('show');

                // Store winner in history
                const now = new Date();
                const dateString = now.toLocaleDateString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US') + ' ' + now.toLocaleTimeString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US');
                const winningSlogan = translations[currentLanguage].winningSlogan;
                winnerHistory.push({
                    value: winner,
                    date: dateString,
                    slogan: winningSlogan
                });
                updateParticipantCount(); // Update to enable/disable export button

                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${currentRotation % 360}deg)`;
                currentRotation = currentRotation % 360;
            }, 6000);
        });

        /**
         * Handles the mode selection (names vs. numbers).
         */
        modeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                drawingMode = event.target.value;
                participants = []; // Clear participants when mode changes
                participantsInput.value = ''; // Clear input field
                if (drawingMode === 'numbers') {
                    participantsInput.placeholder = translations[currentLanguage].numbersPlaceholder;
                } else {
                    participantsInput.placeholder = translations[currentLanguage].namesPlaceholder;
                }
                drawWheel(); // Redraw wheel
            });
        });

        /**
         * Function to perform the Excel export.
         */
        function exportToExcel() {
            if (winnerHistory.length === 0) {
                // This case should ideally be handled by button disabling, but good for robustness
                // No alert, just return.
                return;
            }

            // Prepare data for Excel
            const wsData = [
                translations[currentLanguage].excelHeaders // Headers
            ];
            winnerHistory.forEach(entry => {
                wsData.push([entry.value, entry.date, entry.slogan]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Draw History"); // Sheet name can be static or translated

            // Generate and download the file
            XLSX.writeFile(wb, "Draw_History.xlsx");
        }

        /**
         * Event listener for the Export Excel button. Shows password modal.
         */
        exportExcelBtn.addEventListener('click', () => {
            if (winnerHistory.length === 0) {
                // Display a message for no draws to export
                passwordErrorMsg.textContent = translations[currentLanguage].noDrawsToExport;
                passwordErrorMsg.classList.remove('hidden');
                setTimeout(() => passwordErrorMsg.classList.add('hidden'), 3000);
                return;
            }
            exportPasswordInput.value = ''; // Clear previous input
            passwordErrorMsg.classList.add('hidden'); // Hide any previous error
            showModal(passwordModal);
        });

        /**
         * Event listener for password modal submit button.
         */
        passwordSubmitBtn.addEventListener('click', () => {
            if (exportPasswordInput.value === exportPassword) {
                hideModal(passwordModal);
                exportToExcel();
            } else {
                passwordErrorMsg.textContent = translations[currentLanguage].incorrectPassword;
                passwordErrorMsg.classList.remove('hidden');
            }
        });

        /**
         * Event listener for password modal cancel button.
         */
        passwordCancelBtn.addEventListener('click', () => {
            hideModal(passwordModal);
            exportPasswordInput.value = ''; // Clear input on cancel
            passwordErrorMsg.classList.add('hidden'); // Hide any error
        });

        /**
         * Event listener for Settings button. Shows change password modal.
         */
        settingsBtn.addEventListener('click', () => {
            newPasswordInput.value = '';
            confirmNewPasswordInput.value = '';
            changePasswordErrorMsg.classList.add('hidden');
            showModal(changePasswordModal);
        });

        /**
         * Event listener for change password modal submit button.
         */
        changePasswordSubmitBtn.addEventListener('click', () => {
            const newPass = newPasswordInput.value;
            const confirmPass = confirmNewPasswordInput.value;

            if (newPass === '' || confirmPass === '') {
                changePasswordErrorMsg.textContent = translations[currentLanguage].passwordEmpty;
                changePasswordErrorMsg.classList.remove('hidden');
            } else if (newPass === confirmPass) {
                exportPassword = newPass; // Update the password
                hideModal(changePasswordModal);
                // Optionally, show a success message (e.g., another custom modal)
            } else {
                changePasswordErrorMsg.textContent = translations[currentLanguage].passwordsDoNotMatch;
                changePasswordErrorMsg.classList.remove('hidden');
            }
        });

        /**
         * Event listener for change password modal cancel button.
         */
        changePasswordCancelBtn.addEventListener('click', () => {
            hideModal(changePasswordModal);
            newPasswordInput.value = '';
            confirmNewPasswordInput.value = '';
            changePasswordErrorMsg.classList.add('hidden');
        });

        // Event listener for language selector
        languageSelector.addEventListener('change', (event) => {
            setLanguage(event.target.value);
        });

        // Initial setup
        // Set default language to English on load
        setLanguage('en');
        drawWheel(); // Draw wheel initially
    </script>
</body>
</html>
